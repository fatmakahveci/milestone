ruleorder: create_wgmlst_schema > call_allele > create_cgmlst_schema > pairwise_alignment

configfile: "config.yaml"

import glob, os, sys
from scripts import create_reference

rule all:
	input:
		config["cgmlst_dir"]

rule create_wgmlst_schema:
	input:
		genome_dir = config["genome_dir"],
		trn_file = config["training_file"],
	output:
		directory(config["schema_seed_dir"])
	message: "chewBBACA is creating whole genome MLST (wgMLST) schema."
	log: "logs/chewbbaca.log"
	threads: config["parameters"]["threads"]
	shell:
		"chewBBACA.py CreateSchema -i {input.genome_dir} -o {output} --ptf {input.trn_file} --cpu {threads}"

rule call_allele:
	input:
		genome_dir = config["genome_dir"],
		trn_file = config["training_file"],
		schema_seed_dir = config["schema_seed_dir"],
	output:
		directory(config["allele_call_dir"])
	message: "chewBBACA is calling alleles."
	log: "logs/chewbbaca.log"
	threads: config["parameters"]["threads"]
	shell:
		"chewBBACA.py AlleleCall -i {input.genome_dir} -g {input.schema_seed_dir} -o {output} --cpu {threads} --ptf {input.trn_file}"

# test call quality?

rule create_cgmlst_schema:
	input:
		allele_call_dir = config["allele_call_dir"]
	output:
		directory(config["cgmlst_dir"])
	message: "chewBBACA is creating core genome MLST (cgMLST) schema."
	log: "logs/chewbbaca.log"
	threads: config["parameters"]["threads"]
	run:
		repeated_loci = (glob.glob(f"{input.allele_call_dir}/result*/RepeatedLoci.txt"))[0]
		results_alleles_tsv = (glob.glob(f"{input.allele_call_dir}/result*/results_alleles.tsv"))[0]
		os.system(f"chewBBACA.py ExtractCgMLST -i {results_alleles_tsv} -r {repeated_loci} -p 0.95 -o {output}")

def get_cg_list(cg_schema_file):
	cg_list = []
	with open(cg_schema_file, 'r') as file:
		for line in file.readlines():
			cds = line.strip()
			cg_list.append(f"{cds}")
		file.close()
	return cg_list

cg_list = get_cg_list(f'{config["cgmlst_dir"]}/cgMLSTschema.txt')

rule pairwise_alignment:
	input:
		schema_seed_dir = config["schema_seed_dir"]
	message: "Reference is being prepared..."
	log: "logs/reference.log"
	threads: config["parameters"]["threads"]
	run:

		try:
			Path(f"{input.schema_seed_dir}/references").mkdir(exist_ok=True)  # create reference FASTA directory for each core gene
			Path(f"{input.schema_seed_dir}/alleles").mkdir(exist_ok=True)  # create FASTA directory for each core gene's alleles

		except OSError:
			print(f"Creation of the directories {input.schema_seed_dir}/references and {input.schema_seed_dir}/alleles are failed.")
		
		cds_to_merge_list = [] # to merge all CDSs for reference vcf

		# create reference vcf
		for cds in cg_list:
			create_reference.create_vcf(f"{input.schema_seed_dir}", cds, cds_to_merge_list)